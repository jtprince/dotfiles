#!/usr/bin/env ruby

require 'shellwords'
#File.write("/home/jtprince/randomize_bgk_which_ruby.log", "using ruby: #{RUBY_VERSION} #{RUBY_RELEASE_DATE} #{`which ruby`}")

$VERBOSE = ARGV.delete("-v") ? 3 : nil

def dual_monitors()
  xrandr_output = `xrandr`
  return !!(xrandr_output["HDMI1 connected"] && xrandr_output["HDMI2 connected"])
end

$DUAL_MONITORS = dual_monitors


BKG_DIR = ENV['HOME'] + '/Dropbox/backgrounds'
BKG_DIR << '/dual' if $DUAL_MONITORS


EXTS = %w(png jpg)

files_w_ext = Dir[*EXTS.map {|ext| BKG_DIR + "/*.#{ext}" }]

bkg_prog =
  if `which feh`.size > 0
    # feh is in official repos, so using it
    prog = 'feh --bg-fill'
    prog << ' --no-xinerama' if $DUAL_MONITORS
    prog
  elsif `which hsetroot`.size > 0
    # putting feh as default since hsetroot seems a little flaky at moment
    # (put into AUR from community)
    'hsetroot -fill'
  else
    abort "need feh or hsetroot to work!"
  end

cmd = "#{bkg_prog} '#{Shellwords.escape(files_w_ext.sample)}'"
puts cmd if $VERBOSE
system cmd
