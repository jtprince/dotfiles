#!/usr/bin/env python

# yay -S grimshot tesseract tesseract-data-eng
# pip install pytesseract

import shlex
import os
import datetime
import subprocess
import argparse
from pathlib import Path

DEFAULT_DIR = Path.home() / "screenshots"

parser = argparse.ArgumentParser()
parser.add_argument(
    "type",
    default="screen",
    choices=["screen", "area", "active", "output", "window"],
    help="grab a specific area",
)
parser.add_argument(
    "-o", "--ocr", action="store_true", help="run ocr and copy to clipboard"
)
parser.add_argument(
    "--no-eog", action="store_true", help="do not startup eog with image"
)
args = parser.parse_args()

now = datetime.datetime.now(tz=datetime.timezone.utc)
now_stamp = now.isoformat().replace("T", "--").replace(":", "").split(".")[0]

filename = f"{args.type}-{now_stamp}.png"
image_path = DEFAULT_DIR / filename


cmd = ["grimshot", "save", args.type, str(image_path)]

subprocess.run(cmd)

if args.ocr:
    output = subprocess.check_output(["pytesseract", str(image_path)], text=True)
    quoted = shlex.quote(output)
    subprocess.run(f'echo "{quoted}" | clip', shell=True)

subprocess.run(["eog", str(image_path)])
