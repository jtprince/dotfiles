#!/usr/bin/env python
from __future__ import unicode_literals

import argparse
import subprocess
import time
import textwrap

tmp_prefix = '(tmp)'
parser = argparse.ArgumentParser()
parser.add_argument("message", nargs='*', default=["progress"])
parser.add_argument(
    "-d", "--description", nargs="*", default=[],
    help="description lines (i.e., text after 2 newlines in $EDITOR commit)",
)
parser.add_argument(
    "-t", "--tmp", action='store_true',
    help="prepends {} to the commit message".format(tmp_prefix),
)
parser.add_argument(
    "--no-push", action='store_true',
    help="don't push to remote"
)
parser.add_argument(
    "--no-add", action='store_true',
    help="don't use -a/--all during the commit"
)
parser.add_argument(
    "--no-branch", action='store_true',
    help="don't append the branch name to the commit message"
)
args = parser.parse_args()

description_ar = args.description
message_ar = args.message

message = " ".join(message_ar)

if args.tmp:
    message = tmp_prefix + " " + message

if description_ar:
    description = " ".join(description_ar)
    wrapped_desc = ''.join(textwrap.wrap(description, 72))
    message += ("\n\n" + wrapped_desc)

if not args.no_branch:
    branch = subprocess.check_output("git rev-parse --abbrev-ref HEAD".split()).decode("utf-8").rstrip("\n")
    if branch in ('development', 'production'):
        raise Exception("You are appending dev or production as branch!  Do you really want that?")
    message += ("\n\n" + branch + "\n")

print("COMMIT MESSAGE:")
print(message)

cmd = ["git", "commit"]
if not args.no_add:
    cmd.append("--all")

cmd.append("--message")
cmd.append(message)

subprocess.call(cmd)

time.sleep(1)

if not args.no_push:
    have_remote = subprocess.check_output("git config --get remote.origin.url".split())

    if have_remote:
        subprocess.call("git push".split())
