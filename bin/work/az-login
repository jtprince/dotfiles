#!/usr/bin/env python3
import argparse
import subprocess

SUBSCRIPTIONS = {
    "dev": "sub-enveda-data-dev-01",
    "prod": "sub-enveda-data-prod-01",
}


def run(cmd, check=True, capture=False):
    """Run a command, optionally capturing stdout."""
    return subprocess.run(
        cmd,
        check=check,
        text=True,
        capture_output=capture,
    )


def ensure_login_experience_noninteractive():
    """Disable the subscription selector so az login doesn't prompt."""
    # This is idempotent; safe to call every time.
    run(
        ["az", "config", "set", "core.login_experience_v2=off"],
        check=True,
        capture=True,
    )


def main():
    parser = argparse.ArgumentParser(
        description="Log in to Azure (if needed) and switch subscription."
    )
    parser.add_argument(
        "env",
        nargs="?",
        choices=("dev", "prod"),
        default="dev",
        help="Environment to activate (default: dev)",
    )
    parser.add_argument(
        "-f",
        "--force-login",
        action="store_true",
        help="Force running 'az login' even if already logged in.",
    )

    args = parser.parse_args()
    target_sub = SUBSCRIPTIONS[args.env]

    ensure_login_experience_noninteractive()

    if args.force_login:
        print("Forcing 'az login'...")
        run(["az", "login"])
    else:
        # Try to get/refresh a token for the target subscription.
        try:
            run(
                ["az", "account", "get-access-token", "--subscription", target_sub],
                capture=True,
            )
            print(f"(refreshed access token for {args.env})")
        except subprocess.CalledProcessError:
            print("No valid token / not logged in; running 'az login'...")
            run(["az", "login"])

    # Now set the subscription you actually want.
    run(["az", "account", "set", "--subscription", target_sub])

    # Show the active account/subscription.
    result = run(
        [
            "az",
            "account",
            "show",
            "--query",
            "{name:name, subscriptionId:id}",
            "-o",
            "tsv",
        ],
        capture=True,
    )
    print(result.stdout.strip())


if __name__ == "__main__":
    main()