#!/usr/bin/env python3
"""
Find opposite polarity msrun_id pairs.

Given one or more msrun_ids, finds their opposite polarity pairs from
Benchling. MSruns of opposite polarity are paired by batch_id.

Output format:
  positive_id:negative_id (one pair per line)
  
If an msrun_id has no opposite polarity pair, it's omitted from output.
"""

import argparse
import sys
from enveda_toolkit import get_databricks


def get_opposite_polarity_msrun_id(
    msrun_id: str, env: str = "prod"
) -> tuple[str, str, str] | None:
    """
    Find the opposite polarity msrun_id for a given msrun_id.

    Pairs are matched by sample_description pattern (date prefix, well, replicate)
    but with opposite ionization_mode.

    Args:
        msrun_id: The msrun_id to find the opposite polarity pair for
        env: Environment to query ("prod" or "dev")

    Returns:
        Tuple of (input_msrun_id, opposite_msrun_id, input_polarity),
        or None if no pair exists
    """
    dbx = get_databricks(env)

    # First get the sample description and parse the pattern
    query = f"""
    SELECT sample_description,
           ionization_mode
    FROM benchling_raw.bruker_mass_spec_run
    WHERE `file_registry_id$` = '{msrun_id}'
    """

    df = dbx.query_df(query)

    if df.empty:
        return None

    sample_desc = df["sample_description"].iloc[0]
    polarity = df["ionization_mode"].iloc[0]

    if not sample_desc:
        return None

    # Extract the pattern before the last number (the run-specific ID)
    # Handles two formats:
    #   - "PS211214_S100_1to243_1-C,1_5_1710.d" -> "PS211214_S100_1to243_1-C,1_5_"
    #   - "RS513_260127-1156" -> "RS513_260127-"
    import re
    
    # Try format with .d extension first
    match = re.match(r"^(.+_)(\d+)\.d$", sample_desc)
    if not match:
        # Try format without .d
        match = re.match(r"^(.+[-_])(\d+)$", sample_desc)
    
    if not match:
        return None

    pattern_prefix = match.group(1)  # Everything before the last number

    # Find opposite polarity with matching pattern
    opposite_polarity = (
        "ESI Negative" if polarity == "ESI Positive" else "ESI Positive"
    )

    query2 = f"""
    SELECT `file_registry_id$` as opposite_msrun_id
    FROM benchling_raw.bruker_mass_spec_run
    WHERE sample_description LIKE '{pattern_prefix}%'
      AND ionization_mode = '{opposite_polarity}'
      AND `file_registry_id$` != '{msrun_id}'
    """

    df2 = dbx.query_df(query2)

    if df2.empty:
        return None

    opposite = df2["opposite_msrun_id"].iloc[0]

    return (msrun_id, opposite, polarity)


def format_pair(
    msrun_id: str, opposite: str, polarity: str, format_type: str
) -> str:
    """
    Format a polarity pair for output.

    Args:
        msrun_id: Input msrun_id
        opposite: Opposite polarity msrun_id
        polarity: Polarity of input msrun_id ("ESI Positive" or "ESI Negative")
        format_type: Output format ("colon", "tab", "json")

    Returns:
        Formatted string with positive:negative order
    """
    # Always put positive first, then negative
    if "positive" in polarity.lower():
        pos, neg = msrun_id, opposite
    else:
        pos, neg = opposite, msrun_id

    if format_type == "colon":
        return f"{pos}:{neg}"
    elif format_type == "tab":
        return f"{pos}\t{neg}"
    elif format_type == "json":
        return f'{{"positive": "{pos}", "negative": "{neg}"}}'
    else:
        return f"{pos}:{neg}"


def parse_args():
    parser = argparse.ArgumentParser(
        description=(
            "Find opposite polarity msrun_id pairs. "
            "Output: positive_id:negative_id"
        ),
        epilog=(
            "Examples:\n"
            "  %(prog)s MSB123456\n"
            "  %(prog)s MSB123456 MSB789012\n"
            "  %(prog)s MSB123456 --format tab\n"
        ),
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )
    parser.add_argument(
        "msrun_ids",
        nargs="+",
        help="One or more msrun_id values",
    )
    parser.add_argument(
        "--env",
        choices=["dev", "prod"],
        default="prod",
        help="Databricks environment (default: prod)",
    )
    parser.add_argument(
        "--format",
        choices=["colon", "tab", "json"],
        default="colon",
        help="Output format (default: colon)",
    )
    parser.add_argument(
        "--show-missing",
        action="store_true",
        help="Show msrun_ids that have no opposite polarity pair",
    )
    return parser.parse_args()


def main():
    args = parse_args()

    found_count = 0
    missing_count = 0

    for msrun_id in args.msrun_ids:
        result = get_opposite_polarity_msrun_id(msrun_id, env=args.env)

        if result:
            input_id, opposite_id, polarity = result
            output = format_pair(input_id, opposite_id, polarity, args.format)
            print(output)
            found_count += 1
        else:
            if args.show_missing:
                print(
                    f"# No opposite polarity pair found for {msrun_id}",
                    file=sys.stderr,
                )
            missing_count += 1

    # Exit with non-zero if any were missing (unless we're showing them)
    if missing_count > 0 and not args.show_missing:
        sys.exit(1)


if __name__ == "__main__":
    main()
