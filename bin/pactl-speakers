#!/usr/bin/env python

import argparse
import pulsectl
import time

LIST = "list"
TOGGLE = "toggle"
SET = "set"

parser = argparse.ArgumentParser()
parser.add_argument(
    "action", nargs="?", choices=[LIST, TOGGLE, SET], default=LIST, help="do something"
)
parser.add_argument(
    "set_index", nargs="?", type=int, help="the index to set as default"
)
args = parser.parse_args()


# TODO: pull these from some local file
# NOTE: the order is very important!
BLESSED_DESCRIPTIONS = [
    "Beats Fit Pro",
    "KT_USB_AUDIO Analog Stereo",
    "Tiger Lake-LP Smart Sound Technology Audio Controller Speaker + Headphones",
    "USB PnP Audio Device Analog Stereo",
    "Family 17h (Models 10h-1fh) HD Audio Controller Speaker + Headphones",
    # "Family 17h (Models 10h-1fh) HD Audio Controller Analog Stereo"
    # "TOZO-T10",
    # "Pixel earbuds Analog Stereo",
    # The Philips HDMI output (very weak):
    "Tiger Lake-LP Smart Sound Technology Audio Controller HDMI / DisplayPort 3 Output",
    "Tiger Lake-LP Smart Sound Technology Audio Controller HDMI / DisplayPort 2 Output",
    "Tiger Lake-LP Smart Sound Technology Audio Controller HDMI / DisplayPort 1 Output",
]


def get_pulse():
    return pulsectl.Pulse("pactl-speakers-script")


def get_default_sink_name():
    return get_pulse().server_info().default_sink_name


def is_blessed(sink):
    return sink.description in BLESSED_DESCRIPTIONS


def is_default(sink):
    return sink.name == get_default_sink_name()


def make_label(index, sink):
    label = sink.description
    if is_default(sink):
        label += " <======== DEFAULT"

    if not is_blessed(sink):
        label += " [NOT BLESSED]"
    return f"[{index}] {label}"


def get_sinks():
    return get_pulse().sink_list()


def get_and_display_current_state():
    for index, sink in enumerate(get_sinks()):
        print(make_label(index, sink))


def get_next_best_sink():
    """Returns the next blessed speaker that's not default."""
    sinks = get_sinks()
    for sink_description in BLESSED_DESCRIPTIONS:
        for sink in sinks:
            if sink.description == sink_description:
                if not is_default(sink):
                    return sink


def set_default(sink):
    get_pulse().default_set(sink)


if args.action == TOGGLE:
    sink = get_next_best_sink()
    set_default(sink)
elif args.action == SET:
    sinks = get_sinks()
    max_index = len(sinks) - 1
    if args.set_index > max_index:
        raise parser.error(f"index cannot be > {max_index}")
    set_default(sinks[args.set_index])

get_and_display_current_state()
