#!/usr/bin/env ruby

require 'csv'
require 'json'
require 'optparse'

options = {
  pretty: false
}

opt_parser = OptionParser.new do |opts|
  opts.banner = "Usage: #{File.basename(__FILE__)} [options] <filename>.csv|tsv"

  opts.on("--pretty", "Pretty-print JSON output") do
    options[:pretty] = true
  end

  opts.on("-h", "--help", "Show this help") do
    puts opts
    exit
  end
end

opt_parser.parse!(ARGV)

filename = ARGV.shift
if filename.nil?
  puts opt_parser
  exit 1
end

delimiter = File.extname(filename) == '.tsv' ? "\t" : ","

table = CSV.table(filename, col_sep: delimiter)
table.each do |row|
  hash = row.to_h
  if options[:pretty]
    puts JSON.pretty_generate(hash)
  else
    puts JSON.dump(hash)
  end
end
