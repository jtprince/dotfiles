#!/usr/bin/env ruby
require 'shellwords'

if ARGV.size == 0
  puts "usage: #{File.basename(__FILE__)} [db] cmd"
  exit
end

cmd_args = ARGV.dup

container_name =
  if cmd_args[0] == 'db'
    cmd_args.shift
    cmd_args.push('mysql', '-uroot', '-proot', 'thanos')
    'thanos_mysql-local_1'
  else
    "thanos_web_1"
  end

def escape_quote(arg)
  '\"' + arg + '\"'
end

cmd_args.map! do |arg|
  if arg.start_with?("--") && arg.include?('=')
    flag, val = arg.split('=', 2)
    [flag, escape_quote(val)].join("=")
  else
    arg
  end
end

container_id = `docker ps -a --no-trunc --filter name=#{container_name} --format "{{.ID}}"`.chomp

cmd = %Q{docker exec -it #{container_id} bash -c "#{cmd_args.join(' ')}"}
system cmd
