#!/usr/bin/env ruby

require 'shellwords'
require 'optparse'
require 'json'

SETTINGS_FILE = File.join(ENV['HOME'], 'dev', 'new.doba.com', 'doba', 'settings', 'prod.py')

def demo_settings
  ['testapi@hubspot.com', 'HubSpot', 'demo']
end

def prod_settings
  lines = IO.readlines(SETTINGS_FILE)
  [
    extract_setting(lines, "API_USERNAME"),
    extract_setting(lines, "API_PASSWORD"),
    extract_setting(lines, "API_KEY"),
  ]
end

def extract_setting(lines, key)
  line = lines.find {|line| line.include?(key) }
  line.split(/: '/).last.chomp.chomp(',').chomp("'")
end

username, password, api_key = demo_settings
opt = {}
parser = OptionParser.new do |op|
  op.on("--prod", "use production settings") { username, password, api_key = prod_settings }
  op.on("--get", "get the contact by that email") { opt[:email] = true }
end
parser.parse!

if ARGV.size == 0
  puts parser
  exit
end

args = ARGV.dup

if opt[:email]
  email = args[0]
  args = ["https://api.hubapi.com/contacts/v1/contact/email/#{email}/profile?hapikey=demo"]
end

args = args.map {|arg| Shellwords.escape(arg.sub("hapikey=demo", "hapikey=#{api_key}")) }

reply = `http -a #{Shellwords.escape(username)}:#{Shellwords.escape(password)} #{args.join(" ")}`
puts JSON.pretty_generate(JSON.parse(reply))
