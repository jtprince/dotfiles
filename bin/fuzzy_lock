#!/bin/sh -e

notify-send -u low --expire-time=2 'LOCKING SCREEN!'

# Take a screenshot
# sc /tmp/screen_locked.png

# Pixellate it 10x (note that convert is 2X as fast as mogrify)
#convert  /tmp/screen_locked.png -scale 10% -scale 1000% /tmp/screen_locked_blurred.png

# delete original
#rm /tmp/screen_locked.png

session_type=${XDG_SESSION_TYPE:-x11}
imagefile="/usr/local/share/backgrounds/Braunwald_switzerland.png"

if [ "$session_type" == "wayland" ]; then

    # TODO: sway doesn't turn off music/sound, so to avoid issues we should
    # turnoff any music player by default.
    # Can override and keep music on with --music-on
    if [ "$1" != "--music-on" ]; then
        playerctl stop
    fi

    swaylock -i "$imagefile" --show-keyboard-layout --daemonize

    # Can we turn the screen off after a delay.
    # We can set dpms off, but I don't know of any way for dpms to re-engage
    # when you press space bar or whatever.  I suppose I could make a keyboard
    # shortcut/script to toggle dpms?
    # Anyway, more work is needed with dpms for sure
    # sleep 2; pgrep swaylock && swaymsg output '*' dpms off

else

    # Lock screen displaying this image.
    # (hint: it has to be a png because cairo can't load a jpg)
    # sudo convert /usr/local/share/backgrounds/Braunwald_switzerland.jpg /usr/local/share/backgrounds/Braunwald_switzerland.png
    i3lock -i "$imagefile" -f -p win

    # Turn the screen off after a delay.
    sleep 2; pgrep i3lock && xset dpms force off



fi
