#!/bin/bash

function cmd_exists {
    command -v "$1" >/dev/null 2>&1
}

ultimate_hacking_keyboard_device="/dev/input/by-id/usb-Ultimate_Gadget_Laboratories_Ultimate_Hacking_Keyboard-if01-event-kbd"
session_type=${XDG_SESSION_TYPE:-x11}

if [ "$1" != "late" ]; then

    # gnome keyring
    eval $(gnome-keyring-daemon --start --components=gpg,pkcs11,secrets,ssh)

    # Xresources
    xrdb -merge ~/.Xresources

    # compositing manager
    if cmd_exists picom ; then
        picom-toggle start
    fi

    # notifications
    dunst -config ~/.config/dunst/dunstrc &
    # configure with xfce4-notifyd-config
    # show notifications on: primary display; opacity 70%; disappear after 4 seconds
    # systemctl --user start xfce4-notifyd

    # xmodmap
        # if the UHK keyboard is not plugged in, then remap some keys!
    #    xmodmap ~/.config/xmodmap
    # fi

    # Set capslock as an Esc key and swap left Alt with left Win
    # (this is done in the sway config file if using wayland)
    if [ "$session_type" == "x11" ]; then
        if cmd_exists autoxrandr ; then
            autoxrandr --change
        fi
        if [ ! -e "$ultimate_hacking_keyboard_device" ]; then
            notify-send -u low 'Disabling esc and swapping lalt and lwin.'
            setxkbmap -option caps:escape -option altwin:swap_lalt_lwin
        fi
    fi

    # pulseaudio
    # pulseaudio -D
    start-pulseaudio-x11

    # battery icon
    if cmd_exists cbatticon ; then
        cbatticon &
    fi

    # clipboard
    xclip -silent &

    # network manager applet
    if cmd_exists nm-applet ; then
        nm-applet &
    fi

    # dropbox
    if cmd_exists dropbox-cli ; then
        dropbox-cli start
    fi

    if cmd_exists megasync ; then
        megasync &
    fi

    # music
    # i3-msg 'workspace 8:w8; exec sleep 3 && music-player'

    # now using pclcmd (see pcloud in MEGA/env/../ for oath token)
    # pcloud
    # if cmd_exists psyncgui ; then
    #    ( sleep 10 && psyncgui )&
    # fi

    # sound tray
    pasystray &

    notify-send -u low 'initialized!'

else

    randomise-bkg

fi
